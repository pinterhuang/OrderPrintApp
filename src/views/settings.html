<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨­å®š</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .settings-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .settings-header {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
    }

    .settings-header h1 {
      font-size: 20px;
    }

    .settings-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #333;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .form-checkbox label {
      font-size: 14px;
      cursor: pointer;
    }

    .settings-footer {
      padding: 20px 30px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .divider {
      border: 0;
      border-top: 1px solid #e0e0e0;
      margin: 24px 0;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <div class="settings-header">
      <h1>âš™ï¸ ç³»çµ±è¨­å®š</h1>
    </div>

    <div class="settings-body">
      <form id="settingsForm">
        <div class="section-title">API è¨­å®š</div>

        <div class="form-group">
          <label class="form-label" for="apiUrl">API ç¶²å€</label>
          <input
            type="text"
            id="apiUrl"
            class="form-input"
            placeholder="http://vegetable-university.com/store/api_frontend"
            required
          >
          <div class="form-hint">å¾Œç«¯ API çš„å®Œæ•´ç¶²å€</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="email">ç®¡ç†å“¡ Email</label>
          <input
            type="email"
            id="email"
            class="form-input"
            placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡ Email"
            required
          >
          <div class="form-hint">ç”¨æ–¼ç™»å…¥çš„ç®¡ç†å“¡ Email</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">ç®¡ç†å“¡å¯†ç¢¼</label>
          <input
            type="password"
            id="password"
            class="form-input"
            placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼"
            required
          >
          <div class="form-hint">ç”¨æ–¼ç™»å…¥çš„ç®¡ç†å“¡å¯†ç¢¼</div>
        </div>

        <hr class="divider">

        <div class="section-title">ç›£æ§è¨­å®š</div>

        <div class="form-group">
          <label class="form-label" for="checkInterval">æª¢æŸ¥é–“éš”ï¼ˆç§’ï¼‰</label>
          <input
            type="number"
            id="checkInterval"
            class="form-input"
            min="10"
            max="300"
            value="30"
          >
          <div class="form-hint">æ¯éš”å¤šå°‘ç§’æª¢æŸ¥ä¸€æ¬¡æ–°è¨‚å–®ï¼ˆå»ºè­° 30 ç§’ï¼‰</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="recentMinutes">æª¢æŸ¥ç¯„åœï¼ˆåˆ†é˜ï¼‰</label>
          <input
            type="number"
            id="recentMinutes"
            class="form-input"
            min="1"
            max="10"
            value="2"
          >
          <div class="form-hint">æª¢æŸ¥æœ€è¿‘å¹¾åˆ†é˜å…§çš„è¨‚å–®ï¼ˆå»ºè­° 2 åˆ†é˜ï¼‰</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="printDelay">åˆ—å°é–“éš”ï¼ˆæ¯«ç§’ï¼‰</label>
          <input
            type="number"
            id="printDelay"
            class="form-input"
            min="500"
            max="5000"
            step="100"
            value="1000"
          >
          <div class="form-hint">æ¯ç­†è¨‚å–®ä¹‹é–“çš„åˆ—å°é–“éš”ï¼ˆå»ºè­° 1000 æ¯«ç§’ï¼‰</div>
        </div>

        <hr class="divider">

        <div class="section-title">åˆ—å°è¨­å®š</div>

        <div class="form-group">
          <label class="form-label" for="printerName">å‡ºå–®æ©Ÿåç¨±</label>
          <select id="printerName" class="form-input">
            <option value="">æ­£åœ¨è¼‰å…¥å°è¡¨æ©Ÿæ¸…å–®...</option>
          </select>
          <div class="form-hint">é¸æ“‡è¦ä½¿ç”¨çš„å‡ºå–®æ©Ÿ</div>
        </div>

        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="refreshPrintersBtn" style="width: 100%;">
            ğŸ”„ é‡æ–°æ•´ç†å°è¡¨æ©Ÿæ¸…å–®
          </button>
        </div>

        <div class="form-group">
          <label class="form-label" for="pageSize">ç´™å¼µå°ºå¯¸</label>
          <select id="pageSize" class="form-input">
            <option value="A4">A4</option>
            <option value="A5">A5</option>
            <option value="80mm">80mm (ç†±æ„Ÿç´™)</option>
            <option value="58mm">58mm (ç†±æ„Ÿç´™)</option>
          </select>
          <div class="form-hint">é¸æ“‡åˆ—å°ç´™å¼µå°ºå¯¸</div>
        </div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="landscape">
            <label for="landscape">æ©«å‘åˆ—å°</label>
          </div>
        </div>

        <div class="form-group">
          <button type="button" class="btn btn-secondary" id="testPrintBtn" style="width: 100%;">
            ğŸ–¨ï¸ æ¸¬è©¦åˆ—å°
          </button>
        </div>

        <hr class="divider">

        <div class="section-title">é€šçŸ¥è¨­å®š</div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="enableSound" checked>
            <label for="enableSound">å•Ÿç”¨æç¤ºéŸ³</label>
          </div>
        </div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="enableNotification" checked>
            <label for="enableNotification">å•Ÿç”¨æ¡Œé¢é€šçŸ¥</label>
          </div>
        </div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="autoStart" checked>
            <label for="autoStart">é–‹æ©Ÿè‡ªå‹•å•Ÿå‹•ï¼ˆéœ€é‡æ–°å•Ÿå‹•ç¨‹å¼ï¼‰</label>
          </div>
        </div>
      </form>
    </div>

    <div class="settings-footer">
      <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
      <button type="submit" class="btn btn-primary" id="saveBtn">å„²å­˜è¨­å®š</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // DOM å…ƒç´ 
    const form = document.getElementById('settingsForm');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    const apiUrl = document.getElementById('apiUrl');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const checkInterval = document.getElementById('checkInterval');
    const recentMinutes = document.getElementById('recentMinutes');
    const printDelay = document.getElementById('printDelay');
    const printerName = document.getElementById('printerName');
    const refreshPrintersBtn = document.getElementById('refreshPrintersBtn');
    const testPrintBtn = document.getElementById('testPrintBtn');
    const pageSize = document.getElementById('pageSize');
    const landscape = document.getElementById('landscape');
    const enableSound = document.getElementById('enableSound');
    const enableNotification = document.getElementById('enableNotification');
    const autoStart = document.getElementById('autoStart');

    // è¼‰å…¥è¨­å®š
    document.addEventListener('DOMContentLoaded', () => {
      ipcRenderer.send('get-settings');
      loadPrinters();
    });

    // è¼‰å…¥å°è¡¨æ©Ÿæ¸…å–®
    function loadPrinters() {
      ipcRenderer.send('get-printers');
    }

    ipcRenderer.on('printers-list', (event, printers) => {
      printerName.innerHTML = '';

      if (printers.length === 0) {
        printerName.innerHTML = '<option value="">æ‰¾ä¸åˆ°å°è¡¨æ©Ÿ</option>';
        return;
      }

      printers.forEach(printer => {
        const option = document.createElement('option');
        option.value = printer.name;
        option.textContent = printer.displayName;
        printerName.appendChild(option);
      });

      // è¼‰å…¥å·²å„²å­˜çš„å°è¡¨æ©Ÿè¨­å®š
      ipcRenderer.send('get-settings');
    });

    ipcRenderer.on('settings-data', (event, settings) => {
      apiUrl.value = settings.apiUrl || '';
      email.value = settings.email || '';
      password.value = settings.password || '';
      checkInterval.value = settings.checkInterval / 1000 || 30;
      recentMinutes.value = settings.recentMinutes || 2;
      printDelay.value = settings.printDelay || 1000;

      // è¨­å®šå°è¡¨æ©Ÿ
      if (settings.printerName) {
        printerName.value = settings.printerName;
      }

      // è¨­å®šç‰ˆé¢
      pageSize.value = settings.pageSize || 'A4';
      landscape.checked = settings.landscape || false;

      enableSound.checked = settings.enableSound !== false;
      enableNotification.checked = settings.enableNotification !== false;
      autoStart.checked = settings.autoStart !== false;
    });

    // é‡æ–°æ•´ç†å°è¡¨æ©Ÿæ¸…å–®
    refreshPrintersBtn.addEventListener('click', () => {
      loadPrinters();
    });

    // æ¸¬è©¦åˆ—å°
    testPrintBtn.addEventListener('click', () => {
      if (!printerName.value) {
        alert('è«‹å…ˆé¸æ“‡å°è¡¨æ©Ÿ');
        return;
      }
      ipcRenderer.send('test-print', printerName.value);
    });

    ipcRenderer.on('test-print-result', (event, result) => {
      if (result.success) {
        alert('æ¸¬è©¦åˆ—å°æˆåŠŸï¼è«‹æª¢æŸ¥å‡ºå–®æ©Ÿã€‚');
      } else {
        alert('æ¸¬è©¦åˆ—å°å¤±æ•—ï¼š' + result.error);
      }
    });

    // å„²å­˜è¨­å®š
    saveBtn.addEventListener('click', async () => {
      if (!form.checkValidity()) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
        return;
      }

      // å…ˆæ¸¬è©¦ç™»å…¥ä»¥å–å¾— authToken
      saveBtn.disabled = true;
      saveBtn.textContent = 'ç™»å…¥ä¸­...';

      try {
        const formData = new URLSearchParams();
        formData.append('email', email.value.trim());
        formData.append('password', password.value.trim());

        const loginResponse = await fetch(`${apiUrl.value.trim()}/admin_login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });

        const loginData = await loginResponse.json();

        if (!loginData.success || !loginData.auth_token) {
          throw new Error(loginData.message || 'ç™»å…¥å¤±æ•—');
        }

        const settings = {
          apiUrl: apiUrl.value.trim(),
          email: email.value.trim(),
          password: password.value.trim(),
          authToken: loginData.auth_token,
          checkInterval: parseInt(checkInterval.value) * 1000,
          recentMinutes: parseInt(recentMinutes.value),
          printDelay: parseInt(printDelay.value),
          printerName: printerName.value,
          pageSize: pageSize.value,
          landscape: landscape.checked,
          enableSound: enableSound.checked,
          enableNotification: enableNotification.checked,
          autoStart: autoStart.checked
        };

        ipcRenderer.send('save-settings', settings);
      } catch (error) {
        alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        saveBtn.disabled = false;
        saveBtn.textContent = 'å„²å­˜è¨­å®š';
      }
    });

    ipcRenderer.on('settings-saved', (event, result) => {
      if (result.success) {
        alert('è¨­å®šå·²å„²å­˜ï¼ç³»çµ±å°‡é‡æ–°å•Ÿå‹•ç›£æ§ã€‚');
        window.close();
      } else {
        alert('å„²å­˜è¨­å®šå¤±æ•—ï¼');
      }
    });

    // å–æ¶ˆ
    cancelBtn.addEventListener('click', () => {
      window.close();
    });
  </script>
</body>
</html>
