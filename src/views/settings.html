<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設定</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Microsoft JhengHei", "微軟正黑體", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .settings-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .settings-header {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
    }

    .settings-header h1 {
      font-size: 20px;
    }

    .settings-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #333;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .form-checkbox label {
      font-size: 14px;
      cursor: pointer;
    }

    .settings-footer {
      padding: 20px 30px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .divider {
      border: 0;
      border-top: 1px solid #e0e0e0;
      margin: 24px 0;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <div class="settings-header">
      <h1>⚙️ 系統設定</h1>
    </div>

    <div class="settings-body">
      <form id="settingsForm">
        <div class="section-title">API 設定</div>

        <div class="form-group">
          <label class="form-label" for="apiUrl">API 網址</label>
          <input
            type="text"
            id="apiUrl"
            class="form-input"
            placeholder="http://vegetable-university.com/store/api_frontend"
            required
          >
          <div class="form-hint">後端 API 的完整網址</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="email">管理員 Email</label>
          <input
            type="email"
            id="email"
            class="form-input"
            placeholder="請輸入管理員 Email"
            required
          >
          <div class="form-hint">用於登入的管理員 Email</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">管理員密碼</label>
          <input
            type="password"
            id="password"
            class="form-input"
            placeholder="請輸入管理員密碼"
            required
          >
          <div class="form-hint">用於登入的管理員密碼</div>
        </div>

        <hr class="divider">

        <div class="section-title">監控設定</div>

        <div class="form-group">
          <label class="form-label" for="checkInterval">檢查間隔（秒）</label>
          <input
            type="number"
            id="checkInterval"
            class="form-input"
            min="10"
            max="300"
            value="30"
          >
          <div class="form-hint">每隔多少秒檢查一次新訂單（建議 30 秒）</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="recentMinutes">檢查範圍（分鐘）</label>
          <input
            type="number"
            id="recentMinutes"
            class="form-input"
            min="1"
            max="10"
            value="2"
          >
          <div class="form-hint">檢查最近幾分鐘內的訂單（建議 2 分鐘）</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="printDelay">列印間隔（毫秒）</label>
          <input
            type="number"
            id="printDelay"
            class="form-input"
            min="500"
            max="5000"
            step="100"
            value="1000"
          >
          <div class="form-hint">每筆訂單之間的列印間隔（建議 1000 毫秒）</div>
        </div>

        <hr class="divider">

        <div class="section-title">通知設定</div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="enableSound" checked>
            <label for="enableSound">啟用提示音</label>
          </div>
        </div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="enableNotification" checked>
            <label for="enableNotification">啟用桌面通知</label>
          </div>
        </div>

        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="autoStart" checked>
            <label for="autoStart">開機自動啟動（需重新啟動程式）</label>
          </div>
        </div>
      </form>
    </div>

    <div class="settings-footer">
      <button type="button" class="btn btn-secondary" id="cancelBtn">取消</button>
      <button type="submit" class="btn btn-primary" id="saveBtn">儲存設定</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // DOM 元素
    const form = document.getElementById('settingsForm');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    const apiUrl = document.getElementById('apiUrl');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const checkInterval = document.getElementById('checkInterval');
    const recentMinutes = document.getElementById('recentMinutes');
    const printDelay = document.getElementById('printDelay');
    const enableSound = document.getElementById('enableSound');
    const enableNotification = document.getElementById('enableNotification');
    const autoStart = document.getElementById('autoStart');

    // 載入設定
    document.addEventListener('DOMContentLoaded', () => {
      ipcRenderer.send('get-settings');
    });

    ipcRenderer.on('settings-data', (event, settings) => {
      apiUrl.value = settings.apiUrl || '';
      email.value = settings.email || '';
      password.value = settings.password || '';
      checkInterval.value = settings.checkInterval / 1000 || 30;
      recentMinutes.value = settings.recentMinutes || 2;
      printDelay.value = settings.printDelay || 1000;
      enableSound.checked = settings.enableSound !== false;
      enableNotification.checked = settings.enableNotification !== false;
      autoStart.checked = settings.autoStart !== false;
    });

    // 儲存設定
    saveBtn.addEventListener('click', async () => {
      if (!form.checkValidity()) {
        alert('請填寫所有必填欄位');
        return;
      }

      // 先測試登入以取得 authToken
      saveBtn.disabled = true;
      saveBtn.textContent = '登入中...';

      try {
        const formData = new URLSearchParams();
        formData.append('email', email.value.trim());
        formData.append('password', password.value.trim());

        const loginResponse = await fetch(`${apiUrl.value.trim()}/admin_login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });

        const loginData = await loginResponse.json();

        if (!loginData.success || !loginData.auth_token) {
          throw new Error(loginData.message || '登入失敗');
        }

        const settings = {
          apiUrl: apiUrl.value.trim(),
          email: email.value.trim(),
          password: password.value.trim(),
          authToken: loginData.auth_token,
          checkInterval: parseInt(checkInterval.value) * 1000,
          recentMinutes: parseInt(recentMinutes.value),
          printDelay: parseInt(printDelay.value),
          enableSound: enableSound.checked,
          enableNotification: enableNotification.checked,
          autoStart: autoStart.checked
        };

        ipcRenderer.send('save-settings', settings);
      } catch (error) {
        alert('登入失敗：' + error.message);
        saveBtn.disabled = false;
        saveBtn.textContent = '儲存設定';
      }
    });

    ipcRenderer.on('settings-saved', (event, result) => {
      if (result.success) {
        alert('設定已儲存！系統將重新啟動監控。');
        window.close();
      } else {
        alert('儲存設定失敗！');
      }
    });

    // 取消
    cancelBtn.addEventListener('click', () => {
      window.close();
    });
  </script>
</body>
</html>
