# 流程更新說明

## 更新日期
2025-11-29

## 主要變更

### 更新前的流程
1. 啟動時自動列印當天所有未列印訂單
2. 每 30 秒檢查新訂單並自動列印
3. 無法控制自動列印行為

### 更新後的流程 ✅

#### 1. 啟動時
```
App 啟動
  ↓
載入當天所有 pending 訂單
  ↓
標記列印狀態（已列印/未列印）
  ↓
顯示在訂單列表
  ↓
自動列印：關閉（預設）
  ↓
開始同步訂單（每 30 秒）
```

#### 2. 訂單同步（每 30 秒）
```
取得最近 2 分鐘的 pending 訂單
  ↓
標記列印狀態
  ↓
找出新訂單（不在列表中的）
  ↓
有新訂單？
  ├─ 是 → 🔔 提示音
  │        📢 通知
  │        📋 加入列表
  │        ↓
  │     自動列印已開啟？
  │        ├─ 是 → 🖨️ 自動列印
  │        └─ 否 → 不列印（可手動）
  └─ 否 → 繼續等待
```

#### 3. 自動列印控制
```
點擊「開啟自動列印」
  ↓
✅ 立即列印所有未列印訂單
  ↓
之後新訂單自動列印
  ↓
按鈕變成黃色「關閉自動列印」
────────────────────────
點擊「關閉自動列印」
  ↓
⏸️ 停止自動列印
  ↓
訂單同步繼續（每 30 秒）
  ↓
未列印訂單顯示「列印」按鈕
  ↓
按鈕變成灰色「開啟自動列印」
```

---

## UI 變更

### 1. 按鈕更名
| 舊名稱 | 新名稱 |
|--------|--------|
| 手動檢查 | 手動同步 |
| 暫停/繼續監控 | 開啟/關閉自動列印 |

### 2. 新增功能
- **自動列印 Toggle 按鈕**
  - 關閉狀態：灰色，顯示「開啟自動列印」
  - 開啟狀態：黃色，顯示「關閉自動列印」

- **訂單列印狀態標籤**
  - ✓ 已列印（綠色）
  - ⏹ 未列印（橘色）
  - ⏳ 列印中（藍色）
  - ✗ 列印失敗（紅色）

- **手動列印按鈕**
  - 自動列印關閉時，未列印訂單顯示「列印」按鈕
  - 自動列印開啟時，按鈕隱藏
  - 已列印訂單顯示「重印」按鈕

### 3. 訂單卡片顏色
- 已列印：左側綠色邊框
- 未列印：左側橘色邊框，淺橘背景
- 列印中：左側藍色邊框，淺藍背景
- 列印失敗：左側紅色邊框

---

## 程式碼變更

### 核心邏輯 (OrderPrintManager.js)

#### 新增屬性
```javascript
this.isAutoPrintEnabled = false;  // 自動列印開關
this.currentOrders = [];  // 當前訂單列表
```

#### 新增方法
```javascript
toggleAutoPrint()           // 切換自動列印
loadTodayOrders()          // 載入當天訂單（不自動列印）
syncRecentOrders()         // 同步最近訂單
printUnprintedOrders()     // 列印所有未列印訂單
markOrdersPrintStatus()    // 標記訂單列印狀態
getPrintedOrderIds()       // 取得已列印訂單 ID
updateOrderStatus()        // 更新訂單狀態
```

#### 修改方法
```javascript
start()                    // 啟動時不自動列印
printSingleOrder()         // 發送 orderPrinting 事件
```

### 主程序 (main.js)

#### 新增 IPC 事件
```javascript
'today-orders-loaded'      // 當天訂單已載入
'new-orders-found'         // 發現新訂單
'order-printing'           // 訂單列印中
'auto-print-toggled'       // 自動列印切換
'toggle-auto-print'        // 切換自動列印
'get-auto-print-status'    // 取得自動列印狀態
```

### 前端 (renderer.js)

#### 新增函數
```javascript
handleTodayOrdersLoaded()  // 處理當天訂單載入
handleNewOrdersFound()     // 處理新訂單發現
updateAutoPrintButton()    // 更新自動列印按鈕
printOrder()               // 列印訂單（手動）
```

#### 修改函數
```javascript
createOrderElement()       // 根據狀態顯示按鈕
updateOrderStatus()        // 更新 UI 狀態
```

---

## 優點

### 1. 更靈活的控制
- ✅ 可選擇是否自動列印
- ✅ 可隨時切換自動/手動模式
- ✅ 手動模式下可選擇性列印訂單

### 2. 更好的可見性
- ✅ 清楚顯示所有訂單的列印狀態
- ✅ 未列印訂單一目了然
- ✅ 顏色區分不同狀態

### 3. 更安全的操作
- ✅ 啟動時不會自動印一堆訂單
- ✅ 用戶可先檢查訂單再決定是否列印
- ✅ 避免印錯或重複列印

### 4. 訂單同步不中斷
- ✅ 即使關閉自動列印，訂單仍會同步
- ✅ 隨時掌握最新訂單狀態
- ✅ 想列印時可立即開啟自動列印

---

## 使用場景

### 場景 1：正常營業
```
1. 開啟應用程式
2. 檢查當天訂單列表
3. 點擊「開啟自動列印」
4. 系統自動列印所有未列印訂單
5. 之後新訂單自動列印
```

### 場景 2：測試模式
```
1. 開啟應用程式
2. 查看訂單列表
3. 保持自動列印「關閉」
4. 手動點擊個別訂單的「列印」按鈕測試
```

### 場景 3：暫停列印
```
1. 印表機缺紙/故障
2. 點擊「關閉自動列印」
3. 訂單繼續同步，但不列印
4. 印表機修復後
5. 點擊「開啟自動列印」
6. 系統印出所有累積的未列印訂單
```

### 場景 4：選擇性列印
```
1. 查看訂單列表
2. 保持自動列印「關閉」
3. 只列印特定客戶/金額的訂單
4. 手動點擊「列印」按鈕
```

---

## 向下相容性

- ✅ 資料庫結構沒有變更
- ✅ API 呼叫方式沒有變更
- ✅ 列印記錄格式沒有變更
- ✅ 設定檔格式沒有變更

---

## 升級指南

### 從舊版本升級
1. 關閉應用程式
2. 更新程式碼
3. 重新啟動

### 注意事項
- 舊版本的列印記錄會保留
- 首次啟動會載入當天訂單
- 自動列印預設為「關閉」

---

## 總結

這次更新主要是將「全自動」改為「可控制的自動」，讓使用者有更大的彈性，同時保持訂單同步的即時性。適合各種使用場景，從完全自動到完全手動都能應對。
